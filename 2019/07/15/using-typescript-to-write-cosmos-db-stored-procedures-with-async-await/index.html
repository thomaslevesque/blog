<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Using TypeScript to write Cosmos DB stored procedures with async/await - Thomas Levesque&#39;s .NET Blog</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Using TypeScript to write Cosmos DB stored procedures with async/await" />
<meta property="og:description" content="Disclaimer: I am by no mean a TypeScript expert. In fact, I know very little about JS, npm, gulp, etc. So it&rsquo;s entirely possible I said something really stupid in this article, or maybe I missed a much simpler way of doing things. Don&rsquo;t hesitate to let me know in the comments!
Azure Cosmos DB (formerly known as Azure Document DB) is a NoSQL, multi-model, globally-distributed database hosted in Azure. If you come from relational SQL databases, it&rsquo;s a very different world." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://thomaslevesque.com/2019/07/15/using-typescript-to-write-cosmos-db-stored-procedures-with-async-await/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-07-15T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-07-15T00:00:00+00:00" />


		<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Using TypeScript to write Cosmos DB stored procedures with async/await"/>
<meta name="twitter:description" content="Disclaimer: I am by no mean a TypeScript expert. In fact, I know very little about JS, npm, gulp, etc. So it&rsquo;s entirely possible I said something really stupid in this article, or maybe I missed a much simpler way of doing things. Don&rsquo;t hesitate to let me know in the comments!
Azure Cosmos DB (formerly known as Azure Document DB) is a NoSQL, multi-model, globally-distributed database hosted in Azure. If you come from relational SQL databases, it&rsquo;s a very different world."/>

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	<link rel="stylesheet" href="/css/custom.css">

	<link rel="shortcut icon" href="/favicon.ico">
	<link rel="me" href="https://mastodon.cloud/@thomaslevesque">
		
<script async src="https://www.googletagmanager.com/gtag/js?id=G-18RG5M4ZD6"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-18RG5M4ZD6', { 'anonymize_ip': false });
}
</script>

</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="Thomas Levesque&#39;s .NET Blog" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">Thomas Levesque&#39;s .NET Blog</div>
					<div class="logo__tagline">Tips, tricks and thoughts about .NET development</div>
				</div>
		</a>
	</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/about/">
				
				<span class="menu__text">About</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<a class="main__header__type" href="/posts/">posts</a>
			<h1 class="post__title">Using TypeScript to write Cosmos DB stored procedures with async/await</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class="meta__text" datetime="2019-07-15T00:00:00Z">July 15, 2019</time></div></div>
		</header><div class="content post__content clearfix">
			<p><em><strong>Disclaimer</strong>: I am by no mean a TypeScript expert. In fact, I know very little about JS, npm, gulp, etc. So it&rsquo;s entirely possible I said something really stupid in this article, or maybe I missed a much simpler way of doing things. Don&rsquo;t hesitate to let me know in the comments!</em></p>
<p><a href="https://docs.microsoft.com/en-us/azure/cosmos-db/introduction">Azure Cosmos DB</a> (formerly known as Azure Document DB) is a NoSQL, multi-model, globally-distributed database hosted in Azure. If you come from relational SQL databases, it&rsquo;s a very different world. Some things are great, for instance modeling data is much easier than in a relational database, and performance is excellent. Other things can be disconcerting, such as the lack of support for <a href="https://en.wikipedia.org/wiki/ACID_%28computer_science%29">ACID</a>. From the client&rsquo;s perspective, there are no transactions: you can&rsquo;t update multiple documents atomically. Of course, there&rsquo;s a workaround: you can write stored procedures and triggers, which execute in the context of a transaction. So, when you really, <em>really</em> need multiple updates to be made atomically, you write a stored procedure to do the job.</p>
<h2 id="the-bad-news">The bad news</h2>
<p>Unfortunately, on Cosmos DB, stored procedures are writtenâ€¦ in Javascript ðŸ˜¢ (I know, plenty of folks love Javascript, but I don&rsquo;t. Sue me!). All APIs for database operations are asynchronous (which is a good thing), but these APIs are based on callbacks, not on promises, so even though ECMAScript 2017 is supported, you can&rsquo;t use <code>async</code>/<code>await</code> with them. This fact is enough to turn any non-trivial task (i.e. code that involves branches such as ifs or loops) into a nightmare, at least for a C# developer like meâ€¦ I typically spend a full day to write and debug a stored procedure that should have taken less than an hour with async/await.</p>
<h2 id="promise-based-wrapper">Promise-based wrapper</h2>
<p>Of course, I wouldn&rsquo;t be writing this post if there wasn&rsquo;t a way to make things better. Cosmos DB Product Manager <a href="https://twitter.com/aliuy8">Andrew Liu</a> was kind enough to show me how to write a wrapper around the callback-based API to enable the use of promises and <code>async</code>/<code>await</code>. Basically, it&rsquo;s just a few functions that you can add to your stored procedures:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">setFoo</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> { <span style="color:#a6e22e">feed</span>, <span style="color:#a6e22e">options</span> } <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">queryDocuments</span>(<span style="color:#e6db74">&#34;SELECT * from c&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">doc</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">feed</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">doc</span>.<span style="color:#a6e22e">foo</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bar&#34;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">replaceDocument</span>(<span style="color:#a6e22e">doc</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">main</span>().<span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">err</span> =&gt; <span style="color:#a6e22e">getContext</span>().<span style="color:#a6e22e">abort</span>(<span style="color:#a6e22e">err</span>));
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">queryDocuments</span>(<span style="color:#a6e22e">sqlQuery</span>, <span style="color:#a6e22e">options</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Promise((<span style="color:#a6e22e">resolve</span>, <span style="color:#a6e22e">reject</span>) =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">isAccepted</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">__</span>.<span style="color:#a6e22e">queryDocuments</span>(<span style="color:#a6e22e">__</span>.<span style="color:#a6e22e">getSelfLink</span>(), <span style="color:#a6e22e">sqlQuery</span>, <span style="color:#a6e22e">options</span>, (<span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">feed</span>, <span style="color:#a6e22e">opts</span>) =&gt; {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">err</span>) <span style="color:#a6e22e">reject</span>(<span style="color:#a6e22e">err</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">resolve</span>({ <span style="color:#a6e22e">feed</span>, <span style="color:#a6e22e">options</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">opts</span> });
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">isAccepted</span>) <span style="color:#a6e22e">reject</span>(<span style="color:#66d9ef">new</span> Error(<span style="color:#ae81ff">429</span>, <span style="color:#e6db74">&#34;queryDocuments was not accepted.&#34;</span>));
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">replaceDocument</span>(<span style="color:#a6e22e">doc</span>, <span style="color:#a6e22e">options</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Promise((<span style="color:#a6e22e">resolve</span>, <span style="color:#a6e22e">reject</span>) =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">isAccepted</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">__</span>.<span style="color:#a6e22e">replaceDocument</span>(<span style="color:#a6e22e">doc</span>.<span style="color:#a6e22e">_self</span>, <span style="color:#a6e22e">doc</span>, (<span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">opts</span>) =&gt; {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">err</span>) <span style="color:#a6e22e">reject</span>(<span style="color:#a6e22e">err</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">resolve</span>({ <span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">options</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">opts</span> });
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">isAccepted</span>) <span style="color:#a6e22e">reject</span>(<span style="color:#66d9ef">new</span> Error(<span style="color:#ae81ff">429</span>, <span style="color:#e6db74">&#34;replaceDocument was not accepted.&#34;</span>));
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// and so on for other APIs...
</span></span></span></code></pre></div><p>Note that the stored procedure&rsquo;s entry point (<code>setFoo</code> in this example) cannot be async (if it returns a promise, Cosmos DB won&rsquo;t wait for it to complete), so you need to write another async function (<code>main</code>), call it from the stored procedure&rsquo;s entry point, and catch the error that could be thrown. Note the use of <code>getContext().abort(err)</code>, which aborts and rolls back the current transaction; without this, the exception would be swallowed.</p>
<p>I&rsquo;m not going to show the equivalent code using the callback-based API here, because honestly, it makes my head hurt just thinking about it. But trust me on this: it&rsquo;s not pretty, and much harder to understand.</p>
<h2 id="using-typescript">Using TypeScript</h2>
<p>The code shown above is pretty straightforward, once you have the wrapper functions. However, there are at least two issues with it:</p>
<ul>
<li>This is still Javascript, which is weakly typed, so it&rsquo;s easy to make mistakes that won&rsquo;t be caught until runtime.</li>
<li>Cosmos DB stored procedures and triggers must consist of a single self-contained file; no <code>import</code> or <code>require</code> allowed. Which means you can&rsquo;t share the wrapper functions across multiple stored procedures, you have to include them in each stored procedure. This is annoying&hellip;</li>
</ul>
<p>First, let&rsquo;s see how we can write our stored procedure in TypeScript and reduce the boilerplate code.</p>
<p>Let&rsquo;s start by installing TypeScript. Create a <code>package.json</code> file with the <code>npm init</code> command (it will prompt you for a few details, you can leave everything empty), and run the <code>npm install typescript</code> command. We&rsquo;ll also need the TypeScript definitions of the Cosmos DB server-side APIs. For this, we&rsquo;ll install a npm package named <a href="https://www.npmjs.com/package/@types/documentdb-server"><code>@types/documentdb-server</code></a> which contains the definitions: <code>npm install @types/documentdb-server</code>.</p>
<p>We also need a <code>tsconfig.json</code> file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;exclude&#34;</span><span style="color:#f92672">:</span> [
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;node_modules&#34;</span>
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;compilerOptions&#34;</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;target&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;es2017&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;strict&#34;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Now, let&rsquo;s create a few helpers to use in our stored procedures. I put them all in a <code>CosmosServerScriptHelpers</code> folder. The most important piece is the <code>AsyncCosmosContext</code> class, which is basically a strongly-typed, promise-based wrapper for <a href="https://azure.github.io/azure-cosmosdb-js-server/-__object.html">the <code>__</code> object</a>. It implements the following interface:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">IAsyncCosmosContext</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">readonly</span> <span style="color:#a6e22e">request</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">IRequest</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">readonly</span> <span style="color:#a6e22e">response</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">IResponse</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Basic query and CRUD methods
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">queryDocuments</span>(<span style="color:#a6e22e">sqlQuery</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">any</span>, <span style="color:#a6e22e">options</span><span style="color:#f92672">?:</span> <span style="color:#a6e22e">IFeedOptions</span>)<span style="color:#f92672">:</span> Promise<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">IFeedResult</span><span style="color:#f92672">&gt;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">readDocument</span>(<span style="color:#a6e22e">link</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">string</span>, <span style="color:#a6e22e">options</span><span style="color:#f92672">?:</span> <span style="color:#a6e22e">IReadOptions</span>)<span style="color:#f92672">:</span> Promise<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">any</span><span style="color:#f92672">&gt;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">createDocument</span>(<span style="color:#a6e22e">doc</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">any</span>, <span style="color:#a6e22e">options</span><span style="color:#f92672">?:</span> <span style="color:#a6e22e">ICreateOptions</span>)<span style="color:#f92672">:</span> Promise<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">any</span><span style="color:#f92672">&gt;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">replaceDocument</span>(<span style="color:#a6e22e">doc</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">any</span>, <span style="color:#a6e22e">options</span><span style="color:#f92672">?:</span> <span style="color:#a6e22e">IReplaceOptions</span>)<span style="color:#f92672">:</span> Promise<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">any</span><span style="color:#f92672">&gt;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">deleteDocument</span>(<span style="color:#a6e22e">doc</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">any</span>, <span style="color:#a6e22e">options</span><span style="color:#f92672">?:</span> <span style="color:#a6e22e">IDeleteOptions</span>)<span style="color:#f92672">:</span> Promise<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">any</span><span style="color:#f92672">&gt;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Helper methods
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">readDocumentById</span>(<span style="color:#a6e22e">id</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">string</span>, <span style="color:#a6e22e">options</span><span style="color:#f92672">?:</span> <span style="color:#a6e22e">IReadOptions</span>)<span style="color:#f92672">:</span> Promise<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">any</span><span style="color:#f92672">&gt;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">readDocumentByIdIfExists</span>(<span style="color:#a6e22e">id</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">string</span>, <span style="color:#a6e22e">options</span><span style="color:#f92672">?:</span> <span style="color:#a6e22e">IReadOptions</span>)<span style="color:#f92672">:</span> Promise<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">any</span><span style="color:#f92672">&gt;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">deleteDocumentById</span>(<span style="color:#a6e22e">id</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">string</span>, <span style="color:#a6e22e">options</span><span style="color:#f92672">?:</span> <span style="color:#a6e22e">IDeleteOptions</span>)<span style="color:#f92672">:</span> Promise<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">any</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">queryFirstDocument</span>(<span style="color:#a6e22e">sqlQuery</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">any</span>, <span style="color:#a6e22e">options</span><span style="color:#f92672">?:</span> <span style="color:#a6e22e">IFeedOptions</span>)<span style="color:#f92672">:</span> Promise<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">any</span><span style="color:#f92672">&gt;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">createOrReplaceDocument</span>(<span style="color:#a6e22e">doc</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">any</span>, <span style="color:#a6e22e">options</span><span style="color:#f92672">?:</span> <span style="color:#a6e22e">ICreateOrReplaceOptions</span>)<span style="color:#f92672">:</span> Promise<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">any</span><span style="color:#f92672">&gt;</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>I&rsquo;m not showing the whole code in this article because it would be too long, but you can see the implementation and auxiliary types in the GitHub repo here: <a href="https://github.com/thomaslevesque/TypeScriptCosmosDBStoredProceduresArticle">https://github.com/thomaslevesque/TypeScriptCosmosDBStoredProceduresArticle</a>.</p>
<p>So, how can we use this? Let&rsquo;s look at our previous example again, and see how we can rewrite it in TypeScript using our wrappers:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> {<span style="color:#a6e22e">IAsyncCosmosContext</span>} <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#34;CosmosServerScriptHelpers/IAsyncCosmosContext&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> {<span style="color:#a6e22e">AsyncCosmosContext</span>} <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#34;CosmosServerScriptHelpers/AsyncCosmosContext&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">setFoo</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">main</span>(<span style="color:#a6e22e">context</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">IAsyncCosmosContext</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> { <span style="color:#a6e22e">feed</span>, <span style="color:#a6e22e">options</span> } <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">queryDocuments</span>(<span style="color:#e6db74">&#34;SELECT * from c&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">doc</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">feed</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">doc</span>.<span style="color:#a6e22e">foo</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bar&#34;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">replaceDocument</span>(<span style="color:#a6e22e">doc</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">AsyncCosmosContext</span>()).<span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">err</span> =&gt; <span style="color:#a6e22e">getContext</span>().<span style="color:#a6e22e">abort</span>(<span style="color:#a6e22e">err</span>));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>It looks remarkably similar to the previous version, with just the following changes:</p>
<ul>
<li>We no longer have the wrapper functions in the same file, instead we just import them via the <code>AsyncCosmosContext</code> class.</li>
<li>We pass an instance of <code>AsyncCosmosContext</code> to the <code>main</code> function.</li>
</ul>
<p>This looks pretty good already, but what&rsquo;s bugging me is having to explicitly create the context and do the <code>.catch(...)</code>. So let&rsquo;s create another helper to encapsulate this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> {<span style="color:#a6e22e">IAsyncCosmosContext</span>} <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#34;./IAsyncCosmosContext&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> {<span style="color:#a6e22e">AsyncCosmosContext</span>} <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#34;./AsyncCosmosContext&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AsyncHelper</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Executes the specified async function and returns its result as the response body of the stored procedure.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param func The async function to execute, which returns an object.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#a6e22e">executeAndReturn</span>(<span style="color:#a6e22e">func</span><span style="color:#f92672">:</span> (<span style="color:#a6e22e">context</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">IAsyncCosmosContext</span>) =&gt; Promise<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">any</span><span style="color:#f92672">&gt;</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">executeCore</span>(<span style="color:#a6e22e">func</span>, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Executes the specified async function, but doesn&#39;t write anything to the response body of the stored procedure.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param func The async function to execute, which returns nothing.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#a6e22e">execute</span>(<span style="color:#a6e22e">func</span><span style="color:#f92672">:</span> (<span style="color:#a6e22e">context</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">IAsyncCosmosContext</span>) =&gt; Promise<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">void</span><span style="color:#f92672">&gt;</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">executeCore</span>(<span style="color:#a6e22e">func</span>, <span style="color:#66d9ef">false</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#a6e22e">executeCore</span>(<span style="color:#a6e22e">func</span><span style="color:#f92672">:</span> (<span style="color:#a6e22e">context</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">IAsyncCosmosContext</span>) =&gt; Promise<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">any</span><span style="color:#f92672">&gt;</span>, <span style="color:#a6e22e">setBody</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">boolean</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">func</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">AsyncCosmosContext</span>())
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">result</span> =&gt; {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">setBody</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">__</span>.<span style="color:#a6e22e">response</span>.<span style="color:#a6e22e">setBody</span>(<span style="color:#a6e22e">result</span>);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            })
</span></span><span style="display:flex;"><span>            .<span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">err</span> =&gt; {
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// @ts-ignore
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#a6e22e">getContext</span>().<span style="color:#a6e22e">abort</span>(<span style="color:#a6e22e">err</span>);
</span></span><span style="display:flex;"><span>            });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Using this helper, our stored procedure now looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> {<span style="color:#a6e22e">AsyncHelper</span>} <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#34;CosmosServerScriptHelpers/AsyncHelper&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">setFoo</span>() 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">AsyncHelper</span>.<span style="color:#a6e22e">execute</span>(<span style="color:#66d9ef">async</span> <span style="color:#a6e22e">context</span> =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">queryDocuments</span>(<span style="color:#e6db74">&#34;SELECT * from c&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">doc</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">feed</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">doc</span>.<span style="color:#a6e22e">foo</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bar&#34;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">replaceDocument</span>(<span style="color:#a6e22e">doc</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This reduces the boilerplate code to a minimum. I&rsquo;m pretty happy with it, so let&rsquo;s leave it alone.</p>
<h2 id="generate-the-actual-js-stored-procedure-files">Generate the actual JS stored procedure files</h2>
<p>OK, now comes the tricky part&hellip; We have a bunch of TypeScript files that <code>import</code> each other. But Cosmos DB wants a single, self-contained JavaScript file, with the first function as the entry point of the stored procedure. By default, compiling the TypeScript files to JavaScript will just generate one JS file for each TS file. The <code>--outFile</code> compiler option outputs everything to a single file, but it doesn&rsquo;t really work for us, because it still emits some module related code that won&rsquo;t work in Cosmos DB. What we need, for each stored procedure, is a file that only contains:</p>
<ul>
<li>the stored procedure function itself</li>
<li>all the helper code, without any <code>import</code> or <code>require</code>.</li>
</ul>
<p>Since it doesn&rsquo;t seem possible to get the desired result using just the TypeScript compiler, the solution I found was to use a Gulp pipeline to concatenate the output files and remove the extraneous <code>export</code>s and <code>import</code>s. Here&rsquo;s my <code>gulpfile.js</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">gulp</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#34;gulp&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">ts</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#34;gulp-typescript&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">path</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#34;path&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">flatmap</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#34;gulp-flatmap&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">replace</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;gulp-replace&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">concat</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;gulp-concat&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">gulp</span>.<span style="color:#a6e22e">task</span>(<span style="color:#e6db74">&#34;build-cosmos-server-scripts&#34;</span>, <span style="color:#66d9ef">function</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">sharedScripts</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;CosmosServerScriptHelpers/*.ts&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">tsServerSideScripts</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;StoredProcedures/**/*.ts&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">gulp</span>.<span style="color:#a6e22e">src</span>(<span style="color:#a6e22e">tsServerSideScripts</span>)
</span></span><span style="display:flex;"><span>        .<span style="color:#a6e22e">pipe</span>(<span style="color:#a6e22e">flatmap</span>((<span style="color:#a6e22e">stream</span>, <span style="color:#a6e22e">file</span>) =&gt;
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">outFile</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">join</span>(<span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">dirname</span>(<span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">relative</span>), <span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">basename</span>(<span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">relative</span>, <span style="color:#e6db74">&#34;.ts&#34;</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.js&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">tsProject</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ts</span>.<span style="color:#a6e22e">createProject</span>(<span style="color:#e6db74">&#34;tsconfig.json&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">stream</span>
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">pipe</span>(<span style="color:#a6e22e">gulp</span>.<span style="color:#a6e22e">src</span>(<span style="color:#a6e22e">sharedScripts</span>))
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">pipe</span>(<span style="color:#a6e22e">tsProject</span>())
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">pipe</span>(<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">/^\s*import .+;\s*$/gm</span>, <span style="color:#e6db74">&#34;&#34;</span>))
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">pipe</span>(<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">/^\s*export .+;\s*$/gm</span>, <span style="color:#e6db74">&#34;&#34;</span>))
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">pipe</span>(<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">/^\s*export /gm</span>, <span style="color:#e6db74">&#34;&#34;</span>))
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">pipe</span>(<span style="color:#a6e22e">concat</span>(<span style="color:#a6e22e">outFile</span>))
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">pipe</span>(<span style="color:#a6e22e">gulp</span>.<span style="color:#a6e22e">dest</span>(<span style="color:#e6db74">&#34;StoredProcedures&#34;</span>));
</span></span><span style="display:flex;"><span>        }));
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">gulp</span>.<span style="color:#a6e22e">task</span>(<span style="color:#e6db74">&#34;default&#34;</span>, <span style="color:#a6e22e">gulp</span>.<span style="color:#a6e22e">series</span>(<span style="color:#e6db74">&#34;build-cosmos-server-scripts&#34;</span>));
</span></span></code></pre></div><p>Note that this script requires a few additional npm packages: <code>gulp</code>, <code>gulp-concat</code>, <code>gulp-replace</code>, <code>gulp-flatmap</code>, and <code>gulp-typescript</code>.</p>
<p>Now you can just run <code>gulp</code> and it will produce the appropriate JS file for each TS stored procedure.</p>
<p>To be honest, this solution feels a bit hacky, but it&rsquo;s the best I&rsquo;ve been able to come up with. If you know of a better approach, please let me know!</p>
<h2 id="wrapping-up">Wrapping up</h2>
<p>The out-of-the-box experience for writing Cosmos DB server-side code is not great (to put it mildly), but with just a bit of work, it can be made much better. You can have strong-typing thanks to TypeScript and the type definitions, and you can use <code>async</code>/<code>await</code> to make the code simpler. Note that this approach is also valid for triggers.</p>
<p>Hopefully, a future Cosmos DB update will introduce a proper promise-based API, and maybe even TypeScript support. In the meantime, feel free to use the solution in this post!</p>
<p>The full code for this article is here: <a href="https://github.com/thomaslevesque/TypeScriptCosmosDBStoredProceduresArticle">https://github.com/thomaslevesque/TypeScriptCosmosDBStoredProceduresArticle</a>.</p>

		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/azure/" rel="tag">Azure</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/azure-cosmos-db/" rel="tag">Azure Cosmos DB</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/cosmos-db/" rel="tag">Cosmos DB</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/server-side/" rel="tag">server-side</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/stored-procedure/" rel="tag">stored procedure</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/typescript/" rel="tag">TypeScript</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>

<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="Thomas Levesque avatar" src="/images/avatar.jpg" class="avatar" height="90" width="90">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">About Thomas Levesque</span>
	</div>
	<div class="authorbox__description">
		Thomas Levesque is a French software developer, currently living in QuÃ©bec, Canada.
	</div>
</div>

<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/2019/03/18/scaling-out-asp-net-core-signalr-using-azure-service-bus/" rel="prev">
			<span class="pager__subtitle">Â«&thinsp;Previous</span>
			<p class="pager__title">Scaling out ASP.NET Core SignalR using Azure Service Bus</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/2019/10/14/handling-type-hierarchies-in-cosmos-db-part1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;Â»</span>
			<p class="pager__title">Handling type hierarchies in Cosmos DB (part 1)</p>
		</a>
	</div>
</nav>
<div>
    <script src="https://utteranc.es/client.js"
            repo="thomaslevesque/blog"
            issue-term="pathname"
            label="post-comment"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
</div>


			</div>
			<aside class="sidebar"><div class="widget-search widget">
	<form class="widget-search__form" role="search" method="get" action="https://google.com/search">
		<label>
			<input class="widget-search__field" type="search" placeholder="SEARCHâ€¦" value="" name="q" aria-label="SEARCHâ€¦">
		</label>
		<input class="widget-search__submit" type="submit" value="Search">
		<input type="hidden" name="sitesearch" value="https://thomaslevesque.com/">
	</form>
</div>
<div class="widget-social widget">
    <h4 class="widget-social__title widget__title">Social</h4>
    <div class="widget-social__content widget__content">
        <a class="widget-social__link-custom widget__link" title="GitHub" rel="noopener noreferrer" href="https://github.com/thomaslevesque" target="_blank">
            <svg class="widget-social__link-icon-custom icon icon-github" width="24" height="24" viewBox="0 0 384 374"><path d="m192 0c-106.1 0-192 85.8-192 191.7 0 84.7 55 156.6 131.3 181.9 9.6 1.8 13.1-4.2 13.1-9.2 0-4.6-.2-16.6-.3-32.6-53.4 11.6-64.7-25.7-64.7-25.7-8.7-22.1-21.3-28-21.3-28-17.4-11.9 1.3-11.6 1.3-11.6 19.3 1.4 29.4 19.8 29.4 19.8 17.1 29.3 44.9 20.8 55.9 15.9 1.7-12.4 6.7-20.8 12.2-25.6-42.6-4.8-87.5-21.3-87.5-94.8 0-20.9 7.5-38 19.8-51.4-2-4.9-8.6-24.3 1.9-50.7 0 0 16.1-5.2 52.8 19.7 15.3-4.2 31.7-6.4 48.1-6.5 16.3.1 32.7 2.2 48.1 6.5 36.7-24.8 52.8-19.7 52.8-19.7 10.5 26.4 3.9 45.9 1.9 50.7 12.3 13.4 19.7 30.5 19.7 51.4 0 73.7-44.9 89.9-87.7 94.6 6.9 5.9 13 17.6 13 35.5 0 25.6-.2 46.3-.2 52.6 0 5.1 3.5 11.1 13.2 9.2 76.2-25.5 131.2-97.3 131.2-182 0-105.9-86-191.7-192-191.7z"/></svg>
        </a>
        <a class="widget-social__link-custom widget__link" title="Twitter" rel="noopener noreferrer" href="https://twitter.com/thomaslevesque" target="_blank">
            <svg class="widget-social__link-icon-custom icon icon-twitter" width="24" height="24" viewBox="0 0 384 312"><path d="m384 36.9c-14.1 6.3-29.3 10.5-45.2 12.4 16.3-9.7 28.8-25.2 34.6-43.6-15.2 9-32.1 15.6-50 19.1-14.4-15.2-34.9-24.8-57.5-24.8-43.5 0-78.8 35.3-78.8 78.8 0 6.2.7 12.2 2 17.9-65.5-3.3-123.5-34.6-162.4-82.3-6.7 11.6-10.6 25.2-10.6 39.6 0 27.3 13.9 51.4 35 65.6-12.9-.4-25.1-4-35.7-9.9v1c0 38.2 27.2 70 63.2 77.2-6.6 1.8-13.6 2.8-20.8 2.8-5.1 0-10-.5-14.8-1.4 10 31.3 39.1 54.1 73.6 54.7-27 21.1-60.9 33.7-97.8 33.7-6.4 0-12.6-.4-18.8-1.1 34.9 22.4 76.3 35.4 120.8 35.4 144.9 0 224.1-120 224.1-224.1 0-3.4-.1-6.8-.2-10.2 15.4-11.1 28.7-25 39.3-40.8z"/></svg>
        </a>
        <a class="widget-social__link-custom widget__link" title="RSS feed" rel="noopener noreferrer" href="/index.xml">
            <svg class="widget-social__link-icon-custom icon icon-rss" x="0px" y="0px" width="24" height="24" viewBox="0 0 1000 1000"><path d="M277.2,856.3c0,37.1-13,68.7-39,94.6c-26,26-57.5,39-94.6,39S75,976.9,49,951c-26-26-39-57.5-39-94.6c0-37.1,13-68.7,39-94.6c26-26,57.5-39,94.6-39s68.7,13,94.6,39C264.3,787.7,277.2,819.2,277.2,856.3z M633.6,941.9c0.9,13-3,24.1-11.8,33.4c-8.4,9.7-19.3,14.6-32.7,14.6h-94c-11.6,0-21.6-3.8-29.9-11.5c-8.4-7.7-13-17.3-13.9-28.9c-10.2-106.2-53-197.1-128.4-272.5c-75.4-75.4-166.2-118.2-272.5-128.4c-11.6-0.9-21.2-5.6-28.9-13.9c-7.7-8.4-11.5-18.3-11.5-29.9v-94c0-13.5,4.9-24.4,14.6-32.7c7.9-7.9,17.9-11.8,29.9-11.8H58c74.2,6,145.2,24.7,213,56c67.7,31.3,127.8,73.4,180.2,126.3c52.9,52.4,95,112.5,126.3,180.2C608.8,796.7,627.5,867.7,633.6,941.9L633.6,941.9z M989.9,943.3c0.9,12.5-3.2,23.4-12.5,32.7c-8.3,9.3-19,13.9-32,13.9h-99.5c-12.1,0-22.4-4.1-31-12.2s-13.1-18-13.6-29.6c-5.6-99.8-29-194.5-70.3-284.3c-41.3-89.8-95-167.7-161.1-233.8C503.8,363.9,425.8,310.2,336,269c-89.8-41.3-184.5-65-284.3-71c-11.6-0.5-21.5-5-29.6-13.6c-8.1-8.6-12.2-18.7-12.2-30.3V54.6c0-13,4.6-23.7,13.9-32c8.4-8.4,18.6-12.5,30.6-12.5h2.1c121.6,6,237.9,33.9,349,83.5c111.1,49.6,209.8,117.8,296.1,204.6c86.8,86.3,155,185,204.6,296.1C956,705.4,983.8,821.8,989.9,943.3L989.9,943.3z"/></svg>
        </a>
    </div>
</div>
<div class="widget-recent widget">
	<h4 class="widget__title">Recent Posts</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/2022/11/01/building-a-url-shortener-in-12-lines-of-code-using-cloudflare-workers/">Building a URL shortener in 12 lines of code using Cloudflare Workers</a></li>
			<li class="widget__item"><a class="widget__link" href="/2022/09/19/using-multiple-json-serialization-settings-in-aspnet-core/">Using multiple JSON serialization settings in ASP.NET Core</a></li>
			<li class="widget__item"><a class="widget__link" href="/2021/11/12/building-a-project-that-target-net-45-in-visual-studio-2022/">Building a project that target .NET Framework 4.5 in Visual Studio 2022</a></li>
			<li class="widget__item"><a class="widget__link" href="/2021/11/04/a-quick-review-of-csharp-10-new-language-features/">A quick review of C# 10 new language features</a></li>
			<li class="widget__item"><a class="widget__link" href="/2021/03/19/csharp-9-records-as-strongly-typed-ids-part-5-final-bits-and-conclusion/">C# 9 records as strongly-typed ids - Part 5: final bits and conclusion</a></li>
		</ul>
	</div>
</div>
<div class="widget-taglist widget">
	<h4 class="widget__title">Top tags</h4>
	<div class="widget__content">
		<a class="widget-taglist__link widget__link btn" href="/tags/c%23/" title="c#">c#</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/wpf/" title="wpf">wpf</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/asp.net-core/" title="asp.net-core">asp.net-core</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/xaml/" title="xaml">xaml</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/async/" title="async">async</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/visual-studio/" title="visual-studio">visual-studio</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/json/" title="json">json</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/.net-core/" title=".net-core">.net-core</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/c%23-9/" title="c#-9">c#-9</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/linq/" title="linq">linq</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/unit-testing/" title="unit-testing">unit-testing</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/binding/" title="binding">binding</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/dependency-injection/" title="dependency-injection">dependency-injection</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/markup-extension/" title="markup-extension">markup-extension</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/mvvm/" title="mvvm">mvvm</a>
	</div>
</div>
</aside>
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2022 Thomas Levesque.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>