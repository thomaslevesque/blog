<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>[WPF] Display an animated GIF image - Thomas Levesque&#39;s .NET Blog</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<meta property="og:title" content="[WPF] Display an animated GIF image" />
<meta property="og:description" content="Note: The code in this article is out of date; the current code is hosted on GitHub.
WPF is a great technology, but sometimes it seems to be missing some really basic features&hellip; A frequently mentioned example is the lack of support for animated GIF images. Actually, the GIF format itself is supported by the imaging API, but the Image control only shows the first frame of the animation.
Many solutions to this problem have been proposed on technical forums and blogs, usually variations of the following approaches:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://thomaslevesque.com/2011/03/27/wpf-display-an-animated-gif-image/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2011-03-27T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2011-03-27T00:00:00&#43;00:00" />


	<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="[WPF] Display an animated GIF image"/>
<meta name="twitter:description" content="Note: The code in this article is out of date; the current code is hosted on GitHub.
WPF is a great technology, but sometimes it seems to be missing some really basic features&hellip; A frequently mentioned example is the lack of support for animated GIF images. Actually, the GIF format itself is supported by the imaging API, but the Image control only shows the first frame of the animation.
Many solutions to this problem have been proposed on technical forums and blogs, usually variations of the following approaches:"/>

	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	<link rel="stylesheet" href="/css/custom.css">
	<link rel="shortcut icon" href="/favicon.ico">
		
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-31621259-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container">
		<div class="logo">
			<a class="logo__link" href="/" title="Thomas Levesque&#39;s .NET Blog" rel="home">
				<div class="logo__title">Thomas Levesque&#39;s .NET Blog</div>
				<div class="logo__tagline">Tips, tricks and thoughts about .NET development</div>
			</a>
		</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/about/">
				
				<span class="menu__text">About</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<a class="main__header__type" href="/posts/">posts</a>
			<h1 class="post__title">[WPF] Display an animated GIF image</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class="meta__text" datetime="2011-03-27T00:00:00Z">March 27, 2011</time></div></div>
		</header><div class="content post__content clearfix">
			<p><em><strong>Note:</strong> The code in this article is out of date; the current code is <a href="https://github.com/XamlAnimatedGif/WpfAnimatedGif/">hosted on GitHub</a>.</em></p>
<p>WPF is a great technology, but sometimes it seems to be missing some really basic features&hellip; A frequently mentioned example is the lack of support for animated GIF images. Actually, the GIF format itself is supported by the imaging API, but the <code>Image</code> control only shows the first frame of the animation.</p>
<p>Many solutions to this problem have been proposed on technical forums and blogs, usually variations of the following approaches:</p>
<ul>
<li>Use the <code>MediaElement</code> control: unfortunately this control only supports URI like <code>file://</code> or <code>http://</code>, not the <code>pack://</code> URI schema used for WPF resources; this means the image can&rsquo;t be included in the resources, it has to be in a separate file. Furthermore, transparency for GIF images isn&rsquo;t supported in <code>MediaElement</code>, which makes the final result quite ugly</li>
<li>Use the <code>PictureBox</code> control from Windows Forms, via a <code>WindowsFormsHost</code>: I personnally dislike using WinForms controls in WPF, it really looks like a hack&hellip;</li>
<li>Create a custom control that inherits <code>Image</code> and handles the animation. Some solutions take advantage of the <code>ImageAnimator</code> class from <code>System.Drawing</code> (GDI), others use a WPF animation to change the current frame. It&rsquo;s a rather &ldquo;clean&rdquo; approach, but it forces you to use a specific control for GIF images. Also, the solution using <code>ImageAnimator</code> turns out not to be very smooth, the animation is quite jerky.</li>
</ul>
<p>As you might have guessed, I don&rsquo;t find any of these solutions really satisfying&hellip; Furthermore, none of the implementations I&rsquo;ve seen of the third approach handles the duration of each frame properly, they only assume that all frames last 100ms (which is almost always true, but <em>almost</em>isn&rsquo;t good enough IMHO&hellip;). So I kept the best ideas from each approach I&rsquo;ve seen, and I came up with my own solution. Here are the goals I set to attain:</p>
<ul>
<li>No dependency on Windows Forms or GDI</li>
<li>Display the animated image in a standard <code>Image</code> control</li>
<li>Use the same XAML code for normal and animated images</li>
<li>Support for transparency</li>
<li>Correct handling of frame duration</li>
</ul>
<p>To achieve this result, I started from a very simple, even obvious idea: to animate the image, all you have to do is apply an animation to the <code>Source</code> property of the <code>Image</code> control. WPF provides all the necessary tools to do that; in this case, the <a href="http://msdn.microsoft.com/en-us/library/system.windows.media.animation.objectanimationusingkeyframes.aspx"><code>ObjectAnimationUsingKeyFrames</code></a> class fits the bill perfectly: it allows to specify at what exact time a given value should be assigned to the property, which makes it easy to take the frame duration into account.</p>
<p>The next problem is to extract the frames from the image: fortunately WPF supports this natively, and the <a href="http://msdn.microsoft.com/en-us/library/system.windows.media.imaging.bitmapdecoder.aspx"><code>BitmapDecoder</code></a> class provides a <code>Frames</code> property to do exactly that. So, no big difficulty so far&hellip;</p>
<p>Finally, last obstacle: extract the duration of each frame. It&rsquo;s the part that took me the longest, because I needed to do some research&hellip; I first thought I would need to read the file manually and decode the binary data myself. But eventually the solution is quite simple, and takes advantage of the <a href="http://msdn.microsoft.com/en-us/library/system.windows.media.imaging.bitmapmetadata.aspx"><code>BitmapMetadata</code></a> class. The only difficulty has been to find the &ldquo;path&rdquo; of the metadata that contains the delay, but after a few minutes of trial and error, here it is: <code>/grctlext/Delay</code>.</p>
<p>The final solution is implemented as an attached property named <code>AnimatedSource</code>, that applies to the <code>Image</code> control, and can be used instead of <code>Source</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;Image</span> <span style="color:#a6e22e">Stretch=</span><span style="color:#e6db74">&#34;None&#34;</span> <span style="color:#a6e22e">my:ImageBehavior.AnimatedSource=</span><span style="color:#e6db74">&#34;/Images/animation.gif&#34;</span> <span style="color:#f92672">/&gt;</span>
</code></pre></div><p>This property can also be assigned a normal (not animated) image, it will be displayed normally; therefore this property can be used without worrying about whether the image to display will be animated or not.</p>
<p>So in the end, all the goals have been achieved, and we even get some icing on the cake: this solution also works in the designer (at least in Visual Studio 2010), so the animation is immediately visible when you set the <code>AnimatedSource</code> property :)</p>
<p>Without further ado, here&rsquo;s the complete code:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ImageBehavior</span>
{
    <span style="color:#75715e">#region AnimatedSource
</span><span style="color:#75715e"></span><span style="color:#a6e22e">
</span><span style="color:#a6e22e">    [AttachedPropertyBrowsableForType(typeof(Image))]</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> ImageSource GetAnimatedSource(Image obj)
    {
        <span style="color:#66d9ef">return</span> (ImageSource)obj.GetValue(AnimatedSourceProperty);
    }

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> SetAnimatedSource(Image obj, ImageSource <span style="color:#66d9ef">value</span>)
    {
        obj.SetValue(AnimatedSourceProperty, <span style="color:#66d9ef">value</span>);
    }

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">readonly</span> DependencyProperty AnimatedSourceProperty =
        DependencyProperty.RegisterAttached(
            <span style="color:#e6db74">&#34;AnimatedSource&#34;</span>,
            <span style="color:#66d9ef">typeof</span>(ImageSource),
            <span style="color:#66d9ef">typeof</span>(ImageBehavior),
            <span style="color:#66d9ef">new</span> UIPropertyMetadata(
            <span style="color:#66d9ef">null</span>,
            AnimatedSourceChanged));

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> AnimatedSourceChanged(DependencyObject o, DependencyPropertyChangedEventArgs e)
    {
        Image imageControl = o <span style="color:#66d9ef">as</span> Image;
        <span style="color:#66d9ef">if</span> (imageControl == <span style="color:#66d9ef">null</span>)
            <span style="color:#66d9ef">return</span>;

        <span style="color:#66d9ef">var</span> oldValue = e.OldValue <span style="color:#66d9ef">as</span> ImageSource;
        <span style="color:#66d9ef">var</span> newValue = e.NewValue <span style="color:#66d9ef">as</span> ImageSource;
        <span style="color:#66d9ef">if</span> (oldValue != <span style="color:#66d9ef">null</span>)
        {
            imageControl.BeginAnimation(Image.SourceProperty, <span style="color:#66d9ef">null</span>);
        }
        <span style="color:#66d9ef">if</span> (newValue != <span style="color:#66d9ef">null</span>)
        {
            imageControl.DoWhenLoaded(InitAnimationOrImage);
        }
    }

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> InitAnimationOrImage(Image imageControl)
    {
        BitmapSource source = GetAnimatedSource(imageControl) <span style="color:#66d9ef">as</span> BitmapSource;
        <span style="color:#66d9ef">if</span> (source != <span style="color:#66d9ef">null</span>)
        {
            <span style="color:#66d9ef">var</span> decoder = GetDecoder(source) <span style="color:#66d9ef">as</span> GifBitmapDecoder;
            <span style="color:#66d9ef">if</span> (decoder != <span style="color:#66d9ef">null</span> &amp;&amp; decoder.Frames.Count &gt; <span style="color:#ae81ff">1</span>)
            {
                <span style="color:#66d9ef">var</span> animation = <span style="color:#66d9ef">new</span> ObjectAnimationUsingKeyFrames();
                <span style="color:#66d9ef">var</span> totalDuration = TimeSpan.Zero;
                BitmapSource prevFrame = <span style="color:#66d9ef">null</span>;
                FrameInfo prevInfo = <span style="color:#66d9ef">null</span>;
                <span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">var</span> rawFrame <span style="color:#66d9ef">in</span> decoder.Frames)
                {
                    <span style="color:#66d9ef">var</span> info = GetFrameInfo(rawFrame);
                    <span style="color:#66d9ef">var</span> frame = MakeFrame(
                        source,
                        rawFrame, info,
                        prevFrame, prevInfo);

                    <span style="color:#66d9ef">var</span> keyFrame = <span style="color:#66d9ef">new</span> DiscreteObjectKeyFrame(frame, totalDuration);
                    animation.KeyFrames.Add(keyFrame);
                    
                    totalDuration += info.Delay;
                    prevFrame = frame;
                    prevInfo = info;
                }
                animation.Duration = totalDuration;
                animation.RepeatBehavior = RepeatBehavior.Forever;
                <span style="color:#66d9ef">if</span> (animation.KeyFrames.Count &gt; <span style="color:#ae81ff">0</span>)
                    imageControl.Source = (ImageSource)animation.KeyFrames[<span style="color:#ae81ff">0</span>].Value;
                <span style="color:#66d9ef">else</span>
                    imageControl.Source = decoder.Frames[<span style="color:#ae81ff">0</span>];
                imageControl.BeginAnimation(Image.SourceProperty, animation);
                <span style="color:#66d9ef">return</span>;
            }
        }
        imageControl.Source = source;
        <span style="color:#66d9ef">return</span>;
    }

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> BitmapDecoder GetDecoder(BitmapSource image)
    {
        BitmapDecoder decoder = <span style="color:#66d9ef">null</span>;
        <span style="color:#66d9ef">var</span> frame = image <span style="color:#66d9ef">as</span> BitmapFrame;
        <span style="color:#66d9ef">if</span> (frame != <span style="color:#66d9ef">null</span>)
            decoder = frame.Decoder;

        <span style="color:#66d9ef">if</span> (decoder == <span style="color:#66d9ef">null</span>)
        {
            <span style="color:#66d9ef">var</span> bmp = image <span style="color:#66d9ef">as</span> BitmapImage;
            <span style="color:#66d9ef">if</span> (bmp != <span style="color:#66d9ef">null</span>)
            {
                <span style="color:#66d9ef">if</span> (bmp.StreamSource != <span style="color:#66d9ef">null</span>)
                {
                    bmp.StreamSource.Position = <span style="color:#ae81ff">0</span>;
                    decoder = BitmapDecoder.Create(bmp.StreamSource, bmp.CreateOptions, bmp.CacheOption);
                }
                <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (bmp.UriSource != <span style="color:#66d9ef">null</span>)
                {
                    Uri uri = bmp.UriSource;
                    <span style="color:#66d9ef">if</span> (bmp.BaseUri != <span style="color:#66d9ef">null</span> &amp;&amp; !uri.IsAbsoluteUri)
                        uri = <span style="color:#66d9ef">new</span> Uri(bmp.BaseUri, uri);
                    decoder = BitmapDecoder.Create(uri, bmp.CreateOptions, bmp.CacheOption);
                }
            }
        }

        <span style="color:#66d9ef">return</span> decoder;
    }

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> BitmapSource MakeFrame(
        BitmapSource fullImage,
        BitmapSource rawFrame, FrameInfo frameInfo,
        BitmapSource previousFrame, FrameInfo previousFrameInfo)
    {
        DrawingVisual visual = <span style="color:#66d9ef">new</span> DrawingVisual();
        <span style="color:#66d9ef">using</span> (<span style="color:#66d9ef">var</span> context = visual.RenderOpen())
        {
            <span style="color:#66d9ef">if</span> (previousFrameInfo != <span style="color:#66d9ef">null</span> &amp;&amp; previousFrame != <span style="color:#66d9ef">null</span> &amp;&amp;
                previousFrameInfo.DisposalMethod == FrameDisposalMethod.Combine)
            {
                <span style="color:#66d9ef">var</span> fullRect = <span style="color:#66d9ef">new</span> Rect(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, fullImage.PixelWidth, fullImage.PixelHeight);
                context.DrawImage(previousFrame, fullRect);
            }

            context.DrawImage(rawFrame, frameInfo.Rect);
        }
        <span style="color:#66d9ef">var</span> bitmap = <span style="color:#66d9ef">new</span> RenderTargetBitmap(
            fullImage.PixelWidth, fullImage.PixelHeight,
            fullImage.DpiX, fullImage.DpiY,
            PixelFormats.Pbgra32);
        bitmap.Render(visual);
        <span style="color:#66d9ef">return</span> bitmap;
    }

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FrameInfo</span>
    {
        <span style="color:#66d9ef">public</span> TimeSpan Delay { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
        <span style="color:#66d9ef">public</span> FrameDisposalMethod DisposalMethod { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">double</span> Width { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">double</span> Height { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">double</span> Left { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">double</span> Top { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }

        <span style="color:#66d9ef">public</span> Rect Rect
        {
            <span style="color:#66d9ef">get</span> { <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Rect(Left, Top, Width, Height); }
        }
    }

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">enum</span> FrameDisposalMethod
    {
        Replace = <span style="color:#ae81ff">0</span>,
        Combine = <span style="color:#ae81ff">1</span>,
        RestoreBackground = <span style="color:#ae81ff">2</span>,
        RestorePrevious = <span style="color:#ae81ff">3</span>
    }

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> FrameInfo GetFrameInfo(BitmapFrame frame)
    {
        <span style="color:#66d9ef">var</span> frameInfo = <span style="color:#66d9ef">new</span> FrameInfo
        {
            Delay = TimeSpan.FromMilliseconds(<span style="color:#ae81ff">100</span>),
            DisposalMethod = FrameDisposalMethod.Replace,
            Width = frame.PixelWidth,
            Height = frame.PixelHeight,
            Left = <span style="color:#ae81ff">0</span>,
            Top = <span style="color:#ae81ff">0</span>
        };

        BitmapMetadata metadata;
        <span style="color:#66d9ef">try</span>
        {
            metadata = frame.Metadata <span style="color:#66d9ef">as</span> BitmapMetadata;
            <span style="color:#66d9ef">if</span> (metadata != <span style="color:#66d9ef">null</span>)
            {
                <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">string</span> delayQuery = <span style="color:#e6db74">&#34;/grctlext/Delay&#34;</span>;
                <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">string</span> disposalQuery = <span style="color:#e6db74">&#34;/grctlext/Disposal&#34;</span>;
                <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">string</span> widthQuery = <span style="color:#e6db74">&#34;/imgdesc/Width&#34;</span>;
                <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">string</span> heightQuery = <span style="color:#e6db74">&#34;/imgdesc/Height&#34;</span>;
                <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">string</span> leftQuery = <span style="color:#e6db74">&#34;/imgdesc/Left&#34;</span>;
                <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">string</span> topQuery = <span style="color:#e6db74">&#34;/imgdesc/Top&#34;</span>;

                <span style="color:#66d9ef">var</span> delay = metadata.GetQueryOrNull&lt;<span style="color:#66d9ef">ushort</span>&gt;(delayQuery);
                <span style="color:#66d9ef">if</span> (delay.HasValue)
                    frameInfo.Delay = TimeSpan.FromMilliseconds(<span style="color:#ae81ff">10</span> * delay.Value);

                <span style="color:#66d9ef">var</span> disposal = metadata.GetQueryOrNull&lt;<span style="color:#66d9ef">byte</span>&gt;(disposalQuery);
                <span style="color:#66d9ef">if</span> (disposal.HasValue)
                    frameInfo.DisposalMethod = (FrameDisposalMethod) disposal.Value;

                <span style="color:#66d9ef">var</span> width = metadata.GetQueryOrNull&lt;<span style="color:#66d9ef">ushort</span>&gt;(widthQuery);
                <span style="color:#66d9ef">if</span> (width.HasValue)
                    frameInfo.Width = width.Value;

                <span style="color:#66d9ef">var</span> height = metadata.GetQueryOrNull&lt;<span style="color:#66d9ef">ushort</span>&gt;(heightQuery);
                <span style="color:#66d9ef">if</span> (height.HasValue)
                    frameInfo.Height = height.Value;

                <span style="color:#66d9ef">var</span> left = metadata.GetQueryOrNull&lt;<span style="color:#66d9ef">ushort</span>&gt;(leftQuery);
                <span style="color:#66d9ef">if</span> (left.HasValue)
                    frameInfo.Left = left.Value;

                <span style="color:#66d9ef">var</span> top = metadata.GetQueryOrNull&lt;<span style="color:#66d9ef">ushort</span>&gt;(topQuery);
                <span style="color:#66d9ef">if</span> (top.HasValue)
                    frameInfo.Top = top.Value;
            }
        }
        <span style="color:#66d9ef">catch</span> (NotSupportedException)
        {
        }

        <span style="color:#66d9ef">return</span> frameInfo;
    }

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> T? GetQueryOrNull&lt;T&gt;(<span style="color:#66d9ef">this</span> BitmapMetadata metadata, <span style="color:#66d9ef">string</span> query)
        <span style="color:#66d9ef">where</span> T : <span style="color:#66d9ef">struct</span>
    {
        <span style="color:#66d9ef">if</span> (metadata.ContainsQuery(query))
        {
            <span style="color:#66d9ef">object</span> <span style="color:#66d9ef">value</span> = metadata.GetQuery(query);
            <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">value</span> != <span style="color:#66d9ef">null</span>)
                <span style="color:#66d9ef">return</span> (T) <span style="color:#66d9ef">value</span>;
        }
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
    }

    <span style="color:#75715e">#endregion
</span><span style="color:#75715e"></span>}
</code></pre></div><p>And here&rsquo;s the <code>DoWhenLoaded</code> extension method used in the code above:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> DoWhenLoaded&lt;T&gt;(<span style="color:#66d9ef">this</span> T element, Action&lt;T&gt; action)
    <span style="color:#66d9ef">where</span> T : FrameworkElement
{
    <span style="color:#66d9ef">if</span> (element.IsLoaded)
    {
        action(element);
    }
    <span style="color:#66d9ef">else</span>
    {
        RoutedEventHandler handler = <span style="color:#66d9ef">null</span>;
        handler = (sender, e) =&gt;
        {
            element.Loaded -= handler;
            action(element);
        };
        element.Loaded += handler;
    }
}
</code></pre></div><p>Enjoy :)</p>
<p><strong>Update</strong>: the code that retrieves the frame duration only works on Windows Seven, and on Windows Vista if the <a href="http://support.microsoft.com/kb/971644/en-us">Platform Update</a> is installed (untested). The default duration (100ms) will be used instead on other versions of Windows. I will update the article if I find a solution that works on all operating systems (I know I could use <code>System.Drawing.Bitmap</code>, but I&rsquo;d rather not depend on this&hellip;)</p>
<p><strong>Update 2</strong>: as pointed out by Klaus in the comments, the <code>ImageBehavior</code> class didn&rsquo;t handle some important attributes of the frames: the diposal method (whether a frame should entirely replace the previous one, or be combined with it), and the frame position (Left/Top/Width/Height). I updated the code to handle these attributes properly. Thank you Klaus!</p>
<p><strong>Update 3</strong>: a commenter on the French version of my blog pointed out a problem when the AnimatedSource is an image in a resource dictionary; the UriSource wasn&rsquo;t correctly interpreted when it was a relative URI. This problem is now fixed. Thank you, &ldquo;anonymous&rdquo;!</p>
<p><strong>Update 4</strong>: uploaded an <a href="AnimatedGif.zip">example project</a> to demonstrate the code.</p>
<p><strong>Update 5</strong>: yet another bug fix, for when you use a <code>BitmapImage</code> initialized from a stream. Thanks to Mizutama for spotting this one!</p>
<p><strong>Update 6</strong>: rather than posting improvements to this blog post, I eventually created <a href="https://github.com/XamlAnimatedGif/WpfAnimatedGif/">a project on <strike>CodePlex</strike> GitHub</a> where this class will be maintained. You can also install it using NuGet, the package id is <a href="https://nuget.org/packages/WpfAnimatedGif">WpfAnimatedGif</a>. Thanks to Diego Mijelshon for the suggestion!</p>

		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/animated/" rel="tag">animated</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/gif/" rel="tag">gif</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/wpf/" rel="tag">WPF</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>

<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="Thomas Levesque avatar" src="/images/avatar.jpg" class="avatar" height="90" width="90">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">About Thomas Levesque</span>
	</div>
	<div class="authorbox__description">
		Thomas Levesque is a French software developer from Paris.
	</div>
</div>

<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/2011/03/21/wpf-how-to-bind-to-data-when-the-datacontext-is-not-inherited/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">[WPF] How to bind to data when the DataContext is not inherited</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/2011/09/02/tail-recursion-in-c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Tail recursion in C#</p>
		</a>
	</div>
</nav>

<div>
    <script src="https://utteranc.es/client.js"
            repo="thomaslevesque/blog"
            issue-term="pathname"
            label="post-comment"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
</div>


			</div>
			<aside class="sidebar"><div class="widget-search widget">
	<form class="widget-search__form" role="search" method="get" action="https://google.com/search">
		<label>
			<input class="widget-search__field" type="search" placeholder="SEARCH..." value="" name="q" aria-label="SEARCH...">
		</label>
		<input class="widget-search__submit" type="submit" value="Search">
		<input type="hidden" name="sitesearch" value="https://thomaslevesque.com/" />
	</form>
</div>
<div class="widget-social widget">
    <h4 class="widget-social__title widget__title">Social</h4>
    <div class="widget-social__content widget__content">
        <a class="widget-social__link-custom widget__link" title="GitHub" rel="noopener noreferrer" href="https://github.com/thomaslevesque" target="_blank">
            <svg class="widget-social__link-icon-custom icon icon-github" width="24" height="24" viewBox="0 0 384 374"><path d="m192 0c-106.1 0-192 85.8-192 191.7 0 84.7 55 156.6 131.3 181.9 9.6 1.8 13.1-4.2 13.1-9.2 0-4.6-.2-16.6-.3-32.6-53.4 11.6-64.7-25.7-64.7-25.7-8.7-22.1-21.3-28-21.3-28-17.4-11.9 1.3-11.6 1.3-11.6 19.3 1.4 29.4 19.8 29.4 19.8 17.1 29.3 44.9 20.8 55.9 15.9 1.7-12.4 6.7-20.8 12.2-25.6-42.6-4.8-87.5-21.3-87.5-94.8 0-20.9 7.5-38 19.8-51.4-2-4.9-8.6-24.3 1.9-50.7 0 0 16.1-5.2 52.8 19.7 15.3-4.2 31.7-6.4 48.1-6.5 16.3.1 32.7 2.2 48.1 6.5 36.7-24.8 52.8-19.7 52.8-19.7 10.5 26.4 3.9 45.9 1.9 50.7 12.3 13.4 19.7 30.5 19.7 51.4 0 73.7-44.9 89.9-87.7 94.6 6.9 5.9 13 17.6 13 35.5 0 25.6-.2 46.3-.2 52.6 0 5.1 3.5 11.1 13.2 9.2 76.2-25.5 131.2-97.3 131.2-182 0-105.9-86-191.7-192-191.7z"/></svg>
        </a>
        <a class="widget-social__link-custom widget__link" title="Twitter" rel="noopener noreferrer" href="https://twitter.com/thomaslevesque" target="_blank">
            <svg class="widget-social__link-icon-custom icon icon-twitter" width="24" height="24" viewBox="0 0 384 312"><path d="m384 36.9c-14.1 6.3-29.3 10.5-45.2 12.4 16.3-9.7 28.8-25.2 34.6-43.6-15.2 9-32.1 15.6-50 19.1-14.4-15.2-34.9-24.8-57.5-24.8-43.5 0-78.8 35.3-78.8 78.8 0 6.2.7 12.2 2 17.9-65.5-3.3-123.5-34.6-162.4-82.3-6.7 11.6-10.6 25.2-10.6 39.6 0 27.3 13.9 51.4 35 65.6-12.9-.4-25.1-4-35.7-9.9v1c0 38.2 27.2 70 63.2 77.2-6.6 1.8-13.6 2.8-20.8 2.8-5.1 0-10-.5-14.8-1.4 10 31.3 39.1 54.1 73.6 54.7-27 21.1-60.9 33.7-97.8 33.7-6.4 0-12.6-.4-18.8-1.1 34.9 22.4 76.3 35.4 120.8 35.4 144.9 0 224.1-120 224.1-224.1 0-3.4-.1-6.8-.2-10.2 15.4-11.1 28.7-25 39.3-40.8z"/></svg>
        </a>
        <a class="widget-social__link-custom widget__link" title="RSS feed" rel="noopener noreferrer" href="/index.xml">
            <svg class="widget-social__link-icon-custom icon icon-rss" x="0px" y="0px" width="24" height="24" viewBox="0 0 1000 1000"><path d="M277.2,856.3c0,37.1-13,68.7-39,94.6c-26,26-57.5,39-94.6,39S75,976.9,49,951c-26-26-39-57.5-39-94.6c0-37.1,13-68.7,39-94.6c26-26,57.5-39,94.6-39s68.7,13,94.6,39C264.3,787.7,277.2,819.2,277.2,856.3z M633.6,941.9c0.9,13-3,24.1-11.8,33.4c-8.4,9.7-19.3,14.6-32.7,14.6h-94c-11.6,0-21.6-3.8-29.9-11.5c-8.4-7.7-13-17.3-13.9-28.9c-10.2-106.2-53-197.1-128.4-272.5c-75.4-75.4-166.2-118.2-272.5-128.4c-11.6-0.9-21.2-5.6-28.9-13.9c-7.7-8.4-11.5-18.3-11.5-29.9v-94c0-13.5,4.9-24.4,14.6-32.7c7.9-7.9,17.9-11.8,29.9-11.8H58c74.2,6,145.2,24.7,213,56c67.7,31.3,127.8,73.4,180.2,126.3c52.9,52.4,95,112.5,126.3,180.2C608.8,796.7,627.5,867.7,633.6,941.9L633.6,941.9z M989.9,943.3c0.9,12.5-3.2,23.4-12.5,32.7c-8.3,9.3-19,13.9-32,13.9h-99.5c-12.1,0-22.4-4.1-31-12.2s-13.1-18-13.6-29.6c-5.6-99.8-29-194.5-70.3-284.3c-41.3-89.8-95-167.7-161.1-233.8C503.8,363.9,425.8,310.2,336,269c-89.8-41.3-184.5-65-284.3-71c-11.6-0.5-21.5-5-29.6-13.6c-8.1-8.6-12.2-18.7-12.2-30.3V54.6c0-13,4.6-23.7,13.9-32c8.4-8.4,18.6-12.5,30.6-12.5h2.1c121.6,6,237.9,33.9,349,83.5c111.1,49.6,209.8,117.8,296.1,204.6c86.8,86.3,155,185,204.6,296.1C956,705.4,983.8,821.8,989.9,943.3L989.9,943.3z"/></svg>
        </a>
    </div>
</div>
<div class="widget-recent widget">
	<h4 class="widget__title">Recent Posts</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/2021/11/04/a-quick-review-of-csharp-10-new-language-features/">A quick review of C# 10 new language features</a></li>
			<li class="widget__item"><a class="widget__link" href="/2021/03/19/csharp-9-records-as-strongly-typed-ids-part-5-final-bits-and-conclusion/">C# 9 records as strongly-typed ids - Part 5: final bits and conclusion</a></li>
			<li class="widget__item"><a class="widget__link" href="/2020/12/23/csharp-9-records-as-strongly-typed-ids-part-4-entity-framework-core-integration/">C# 9 records as strongly-typed ids - Part 4: Entity Framework Core integration</a></li>
			<li class="widget__item"><a class="widget__link" href="/2020/12/07/csharp-9-records-as-strongly-typed-ids-part-3-json-serialization/">C# 9 records as strongly-typed ids - Part 3: JSON serialization</a></li>
			<li class="widget__item"><a class="widget__link" href="/2020/11/23/csharp-9-records-as-strongly-typed-ids-part-2-aspnet-core-route-and-query-parameters/">C# 9 records as strongly-typed ids - Part 2: ASP.NET Core route and query parameters</a></li>
		</ul>
	</div>
</div>
<div class="widget-taglist widget">
	<h4 class="widget__title">Top tags</h4>
	<div class="widget__content">
		<a class="widget-taglist__link widget__link btn" href="/tags/c%23/" title="c#">c#</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/wpf/" title="wpf">wpf</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/asp.net-core/" title="asp.net-core">asp.net-core</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/xaml/" title="xaml">xaml</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/async/" title="async">async</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/visual-studio/" title="visual-studio">visual-studio</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/.net-core/" title=".net-core">.net-core</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/json/" title="json">json</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/c%23-9/" title="c#-9">c#-9</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/linq/" title="linq">linq</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/unit-testing/" title="unit-testing">unit-testing</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/binding/" title="binding">binding</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/dependency-injection/" title="dependency-injection">dependency-injection</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/markup-extension/" title="markup-extension">markup-extension</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/mvvm/" title="mvvm">mvvm</a>
	</div>
</div>
</aside>
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2021 Thomas Levesque.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>