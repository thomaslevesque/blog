<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>[WPF 4.5] Subscribing to an event using a markup extension - Thomas Levesque&#39;s .NET Blog</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="[WPF 4.5] Subscribing to an event using a markup extension" />
<meta property="og:description" content="It&rsquo;s been a while since I last wrote about markup extensions&hellip; The release of Visual Studio 11 Developer Preview, which introduces a number of new features to WPF, just gave me a reason to play with them again. The feature I&rsquo;m going to discuss here is perhaps not the most impressive, but it fills in a gap of the previous versions: the support of markup extensions for events.
Until now, it was possible to use a markup extension in XAML to assign a value to a property, but we couldn&rsquo;t do the same to subscribe to an event." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://thomaslevesque.com/2011/09/23/wpf-4-5-subscribing-to-an-event-using-a-markup-extension/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2011-09-23T00:00:00+00:00" />
<meta property="article:modified_time" content="2011-09-23T00:00:00+00:00" />


		<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="[WPF 4.5] Subscribing to an event using a markup extension"/>
<meta name="twitter:description" content="It&rsquo;s been a while since I last wrote about markup extensions&hellip; The release of Visual Studio 11 Developer Preview, which introduces a number of new features to WPF, just gave me a reason to play with them again. The feature I&rsquo;m going to discuss here is perhaps not the most impressive, but it fills in a gap of the previous versions: the support of markup extensions for events.
Until now, it was possible to use a markup extension in XAML to assign a value to a property, but we couldn&rsquo;t do the same to subscribe to an event."/>

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	<link rel="stylesheet" href="/css/custom.css">

	<link rel="shortcut icon" href="/favicon.ico">
		
<script async src="https://www.googletagmanager.com/gtag/js?id=G-18RG5M4ZD6"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-18RG5M4ZD6', { 'anonymize_ip': false });
}
</script>

</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="Thomas Levesque&#39;s .NET Blog" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">Thomas Levesque&#39;s .NET Blog</div>
					<div class="logo__tagline">Tips, tricks and thoughts about .NET development</div>
				</div>
		</a>
	</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/about/">
				
				<span class="menu__text">About</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<a class="main__header__type" href="/posts/">posts</a>
			<h1 class="post__title">[WPF 4.5] Subscribing to an event using a markup extension</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class="meta__text" datetime="2011-09-23T00:00:00Z">September 23, 2011</time></div></div>
		</header><div class="content post__content clearfix">
			<p>It&rsquo;s been a while since I last wrote about markup extensions&hellip; The release of Visual Studio 11 Developer Preview, which introduces a number of <a href="http://msdn.microsoft.com/en-us/library/bb613588%28v=VS.110%29.aspx">new features</a> to WPF, just gave me a reason to play with them again. The feature I&rsquo;m going to discuss here is perhaps not the most impressive, but it fills in a gap of the previous versions: the support of markup extensions for events.</p>
<p>Until now, it was possible to use a markup extension in XAML to assign a value to a property, but we couldn&rsquo;t do the same to subscribe to an event. In WPF 4.5, it is now possible. So here is a small example of the kind we can do with it&hellip;</p>
<p>When using the MVVM pattern, we often associate commands of the ViewModel with controls of the view, via the binding mechanism. This approach usually works well, but it has some downsides:</p>
<ul>
<li>it introduces a lot of boilerplate code in the ViewModel</li>
<li>not all controls have a <code>Command</code> property (actually, most don&rsquo;t), and when this property exists, it corresponds only to one event of the control (e.g. the click on a button). There is no really easy way to &ldquo;bind&rdquo; the other events to commands of the ViewModel</li>
</ul>
<p>It would be nice to be able to bind events directly to ViewModel methods, like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;Button</span> <span style="color:#a6e22e">Content=</span><span style="color:#e6db74">&#34;Click me&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Click=</span><span style="color:#e6db74">&#34;{my:EventBinding OnClick}&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span></code></pre></div><p>With the <code>OnClick</code> method defined in the ViewModel:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> OnClick(<span style="color:#66d9ef">object</span> sender, EventArgs e)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    MessageBox.Show(<span style="color:#e6db74">&#34;Hello world!&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Well, this is now possible! Here&rsquo;s a proof of concept&hellip; The <code>EventBindingExtension</code> class shown below first gets the <code>DataContext</code> of the control, then looks for the specified method on the <code>DataContext</code>, and eventually returns a delegate for this method:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Collections.Generic;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.ComponentModel;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Diagnostics;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Linq;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Reflection;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Windows;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Windows.Markup;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EventBindingExtension</span> : MarkupExtension
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> EventBindingExtension() { }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> EventBindingExtension(<span style="color:#66d9ef">string</span> eventHandlerName)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.EventHandlerName = eventHandlerName;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">        [ConstructorArgument(&#34;eventHandlerName&#34;)]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> EventHandlerName { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">object</span> ProvideValue(IServiceProvider serviceProvider)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">string</span>.IsNullOrEmpty(EventHandlerName))
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ArgumentException(<span style="color:#e6db74">&#34;The EventHandlerName property is not set&#34;</span>, <span style="color:#e6db74">&#34;EventHandlerName&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> target = (IProvideValueTarget)serviceProvider.GetService(<span style="color:#66d9ef">typeof</span>(IProvideValueTarget));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            EventInfo eventInfo = target.TargetProperty <span style="color:#66d9ef">as</span> EventInfo;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (eventInfo == <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> InvalidOperationException(<span style="color:#e6db74">&#34;The target property must be an event&#34;</span>);
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">object</span> dataContext = GetDataContext(target.TargetObject);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (dataContext == <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> InvalidOperationException(<span style="color:#e6db74">&#34;No DataContext found&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> handler = GetHandler(dataContext, eventInfo, EventHandlerName);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (handler == <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ArgumentException(<span style="color:#e6db74">&#34;No valid event handler was found&#34;</span>, <span style="color:#e6db74">&#34;EventHandlerName&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> handler;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#region Helper methods</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">object</span> GetHandler(<span style="color:#66d9ef">object</span> dataContext, EventInfo eventInfo, <span style="color:#66d9ef">string</span> eventHandlerName)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            Type dcType = dataContext.GetType();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> method = dcType.GetMethod(
</span></span><span style="display:flex;"><span>                eventHandlerName,
</span></span><span style="display:flex;"><span>                GetParameterTypes(eventInfo));
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (method != <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (method.IsStatic)
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> Delegate.CreateDelegate(eventInfo.EventHandlerType, method);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> Delegate.CreateDelegate(eventInfo.EventHandlerType, dataContext, method);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">static</span> Type[] GetParameterTypes(EventInfo eventInfo)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> invokeMethod = eventInfo.EventHandlerType.GetMethod(<span style="color:#e6db74">&#34;Invoke&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> invokeMethod.GetParameters().Select(p =&gt; p.ParameterType).ToArray();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">object</span> GetDataContext(<span style="color:#66d9ef">object</span> target)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> depObj = target <span style="color:#66d9ef">as</span> DependencyObject;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (depObj == <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> depObj.GetValue(FrameworkElement.DataContextProperty)
</span></span><span style="display:flex;"><span>                ?? depObj.GetValue(FrameworkContentElement.DataContextProperty);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">#</span>endregion
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>This class can be used as shown in the example above.</p>
<p>As it is now, this markup extension has an annoying limitation: the <code>DataContext</code> must be set before the call to <code>ProvideValue</code>, otherwise it won&rsquo;t be possible to find the event handler method. A solution could be to subscribe to the <code>DataContextChanged</code> event to look for the method after the <code>DataContext</code> is set, but in the meantime we still need to return something&hellip; and we can&rsquo;t return null, because it would cause an exception (since you can&rsquo;t subscribe to an event with a null handler). So we need to return a dummy handler generated dynamically from the event signature. It makes things a bit harder&hellip; but it&rsquo;s still feasible.</p>
<p>Here&rsquo;s a second version that implements this improvement :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Collections.Generic;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.ComponentModel;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Diagnostics;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Linq;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Reflection;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Reflection.Emit;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Windows;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Windows.Markup;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EventBindingExtension</span> : MarkupExtension
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> EventInfo _eventInfo;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> EventBindingExtension() { }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> EventBindingExtension(<span style="color:#66d9ef">string</span> eventHandlerName)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.EventHandlerName = eventHandlerName;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">        [ConstructorArgument(&#34;eventHandlerName&#34;)]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> EventHandlerName { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">object</span> ProvideValue(IServiceProvider serviceProvider)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">string</span>.IsNullOrEmpty(EventHandlerName))
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ArgumentException(<span style="color:#e6db74">&#34;The EventHandlerName property is not set&#34;</span>, <span style="color:#e6db74">&#34;EventHandlerName&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> target = (IProvideValueTarget)serviceProvider.GetService(<span style="color:#66d9ef">typeof</span>(IProvideValueTarget));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> targetObj = target.TargetObject <span style="color:#66d9ef">as</span> DependencyObject;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (targetObj == <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> InvalidOperationException(<span style="color:#e6db74">&#34;The target object must be a DependencyObject&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            _eventInfo = target.TargetProperty <span style="color:#66d9ef">as</span> EventInfo;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (_eventInfo == <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> InvalidOperationException(<span style="color:#e6db74">&#34;The target property must be an event&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">object</span> dataContext = GetDataContext(targetObj);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (dataContext == <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                SubscribeToDataContextChanged(targetObj);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> GetDummyHandler(_eventInfo.EventHandlerType);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> handler = GetHandler(dataContext, _eventInfo, EventHandlerName);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (handler == <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                Trace.TraceError(
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;EventBinding: no suitable method named &#39;{0}&#39; found in type &#39;{1}&#39; to handle event &#39;{2&#39;}&#34;</span>,
</span></span><span style="display:flex;"><span>                    EventHandlerName,
</span></span><span style="display:flex;"><span>                    dataContext.GetType(),
</span></span><span style="display:flex;"><span>                    _eventInfo);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> GetDummyHandler(_eventInfo.EventHandlerType);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> handler;
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#region Helper methods</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">static</span> Delegate GetHandler(<span style="color:#66d9ef">object</span> dataContext, EventInfo eventInfo, <span style="color:#66d9ef">string</span> eventHandlerName)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            Type dcType = dataContext.GetType();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> method = dcType.GetMethod(
</span></span><span style="display:flex;"><span>                eventHandlerName,
</span></span><span style="display:flex;"><span>                GetParameterTypes(eventInfo.EventHandlerType));
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (method != <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (method.IsStatic)
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> Delegate.CreateDelegate(eventInfo.EventHandlerType, method);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> Delegate.CreateDelegate(eventInfo.EventHandlerType, dataContext, method);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">static</span> Type[] GetParameterTypes(Type delegateType)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> invokeMethod = delegateType.GetMethod(<span style="color:#e6db74">&#34;Invoke&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> invokeMethod.GetParameters().Select(p =&gt; p.ParameterType).ToArray();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">object</span> GetDataContext(DependencyObject target)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> target.GetValue(FrameworkElement.DataContextProperty)
</span></span><span style="display:flex;"><span>                ?? target.GetValue(FrameworkContentElement.DataContextProperty);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">readonly</span> Dictionary&lt;Type, Delegate&gt; _dummyHandlers = <span style="color:#66d9ef">new</span> Dictionary&lt;Type, Delegate&gt;();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">static</span> Delegate GetDummyHandler(Type eventHandlerType)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            Delegate handler;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (!_dummyHandlers.TryGetValue(eventHandlerType, <span style="color:#66d9ef">out</span> handler))
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                handler = CreateDummyHandler(eventHandlerType);
</span></span><span style="display:flex;"><span>                _dummyHandlers[eventHandlerType] = handler;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> handler;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">static</span> Delegate CreateDummyHandler(Type eventHandlerType)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> parameterTypes = GetParameterTypes(eventHandlerType);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> returnType = eventHandlerType.GetMethod(<span style="color:#e6db74">&#34;Invoke&#34;</span>).ReturnType;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> dm = <span style="color:#66d9ef">new</span> DynamicMethod(<span style="color:#e6db74">&#34;DummyHandler&#34;</span>, returnType, parameterTypes);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> il = dm.GetILGenerator();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (returnType != <span style="color:#66d9ef">typeof</span>(<span style="color:#66d9ef">void</span>))
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (returnType.IsValueType)
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">var</span> local = il.DeclareLocal(returnType);
</span></span><span style="display:flex;"><span>                    il.Emit(OpCodes.Ldloca_S, local);
</span></span><span style="display:flex;"><span>                    il.Emit(OpCodes.Initobj, returnType);
</span></span><span style="display:flex;"><span>                    il.Emit(OpCodes.Ldloc_0);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    il.Emit(OpCodes.Ldnull);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            il.Emit(OpCodes.Ret);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> dm.CreateDelegate(eventHandlerType);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> SubscribeToDataContextChanged(DependencyObject targetObj)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            DependencyPropertyDescriptor
</span></span><span style="display:flex;"><span>                .FromProperty(FrameworkElement.DataContextProperty, targetObj.GetType())
</span></span><span style="display:flex;"><span>                .AddValueChanged(targetObj, TargetObject_DataContextChanged);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> UnsubscribeFromDataContextChanged(DependencyObject targetObj)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            DependencyPropertyDescriptor
</span></span><span style="display:flex;"><span>                .FromProperty(FrameworkElement.DataContextProperty, targetObj.GetType())
</span></span><span style="display:flex;"><span>                .RemoveValueChanged(targetObj, TargetObject_DataContextChanged);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> TargetObject_DataContextChanged(<span style="color:#66d9ef">object</span> sender, EventArgs e)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            DependencyObject targetObj = sender <span style="color:#66d9ef">as</span> DependencyObject;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (targetObj == <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">object</span> dataContext = GetDataContext(targetObj);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (dataContext == <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> handler = GetHandler(dataContext, _eventInfo, EventHandlerName);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (handler != <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                _eventInfo.AddEventHandler(targetObj, handler);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            UnsubscribeFromDataContextChanged(targetObj);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">#</span>endregion
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>So this is the kind of things we can do thanks to this new WPF feature. We could also imagine a behavior system similar to what we can do with attached properties, e.g. to execute a standard action when an event occurs. There are lots of possible applications for this, I leave it to you to find them ;)</p>

		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/.net-4.5/" rel="tag">.NET 4.5</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/events/" rel="tag">events</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/markup-extension/" rel="tag">markup extension</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/wpf/" rel="tag">WPF</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/xaml/" rel="tag">XAML</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>

<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="Thomas Levesque avatar" src="/images/avatar.jpg" class="avatar" height="90" width="90">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">About Thomas Levesque</span>
	</div>
	<div class="authorbox__description">
		Thomas Levesque is a French software developer, currently living in Québec, Canada.
	</div>
</div>

<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/2011/09/02/tail-recursion-in-c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Tail recursion in C#</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/2011/10/01/wpf-creating-parameterized-styles-with-attached-properties/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">[WPF] Creating parameterized styles with attached properties</p>
		</a>
	</div>
</nav>
<div class="giscus">
    <script src="https://giscus.app/client.js"
        data-repo="thomaslevesque/blog"
        data-repo-id="MDEwOlJlcG9zaXRvcnkyNTkxNDk0Njk="
        data-category="Blog comments"
        data-category-id="DIC_kwDOD3JOnc4CPJVg"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="light"
        data-lang="en"
        crossorigin="anonymous"
        async>
    </script>
</div>


			</div>
			<aside class="sidebar"><div class="widget-search widget">
	<form class="widget-search__form" role="search" method="get" action="https://google.com/search">
		<label>
			<input class="widget-search__field" type="search" placeholder="SEARCH…" value="" name="q" aria-label="SEARCH…">
		</label>
		<input class="widget-search__submit" type="submit" value="Search">
		<input type="hidden" name="sitesearch" value="https://thomaslevesque.com/">
	</form>
</div>
<div class="widget-social widget">
	<h4 class="widget-social__title widget__title">Social</h4>
	<div class="widget-social__content widget__content">
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="Twitter" rel="noopener noreferrer" href="https://twitter.com/thomaslevesque" target="_blank">
				<svg class="widget-social__link-icon icon icon-twitter" width="24" height="24" viewBox="0 0 384 312"><path d="m384 36.9c-14.1 6.3-29.3 10.5-45.2 12.4 16.3-9.7 28.8-25.2 34.6-43.6-15.2 9-32.1 15.6-50 19.1-14.4-15.2-34.9-24.8-57.5-24.8-43.5 0-78.8 35.3-78.8 78.8 0 6.2.7 12.2 2 17.9-65.5-3.3-123.5-34.6-162.4-82.3-6.7 11.6-10.6 25.2-10.6 39.6 0 27.3 13.9 51.4 35 65.6-12.9-.4-25.1-4-35.7-9.9v1c0 38.2 27.2 70 63.2 77.2-6.6 1.8-13.6 2.8-20.8 2.8-5.1 0-10-.5-14.8-1.4 10 31.3 39.1 54.1 73.6 54.7-27 21.1-60.9 33.7-97.8 33.7-6.4 0-12.6-.4-18.8-1.1 34.9 22.4 76.3 35.4 120.8 35.4 144.9 0 224.1-120 224.1-224.1 0-3.4-.1-6.8-.2-10.2 15.4-11.1 28.7-25 39.3-40.8z"/></svg>
				<span>Twitter</span>
			</a>
		</div>
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="GitHub" rel="noopener noreferrer" href="https://github.com/thomaslevesque" target="_blank">
				<svg class="widget-social__link-icon icon icon-github" width="24" height="24" viewBox="0 0 384 374"><path d="m192 0c-106.1 0-192 85.8-192 191.7 0 84.7 55 156.6 131.3 181.9 9.6 1.8 13.1-4.2 13.1-9.2 0-4.6-.2-16.6-.3-32.6-53.4 11.6-64.7-25.7-64.7-25.7-8.7-22.1-21.3-28-21.3-28-17.4-11.9 1.3-11.6 1.3-11.6 19.3 1.4 29.4 19.8 29.4 19.8 17.1 29.3 44.9 20.8 55.9 15.9 1.7-12.4 6.7-20.8 12.2-25.6-42.6-4.8-87.5-21.3-87.5-94.8 0-20.9 7.5-38 19.8-51.4-2-4.9-8.6-24.3 1.9-50.7 0 0 16.1-5.2 52.8 19.7 15.3-4.2 31.7-6.4 48.1-6.5 16.3.1 32.7 2.2 48.1 6.5 36.7-24.8 52.8-19.7 52.8-19.7 10.5 26.4 3.9 45.9 1.9 50.7 12.3 13.4 19.7 30.5 19.7 51.4 0 73.7-44.9 89.9-87.7 94.6 6.9 5.9 13 17.6 13 35.5 0 25.6-.2 46.3-.2 52.6 0 5.1 3.5 11.1 13.2 9.2 76.2-25.5 131.2-97.3 131.2-182 0-105.9-86-191.7-192-191.7z"/></svg>
				<span>GitHub</span>
			</a>
		</div>

		
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="Mastodon"  rel="me" href="https://mastodon.cloud/@thomaslevesque" target="_blank">
					<svg class="widget-social__link-icon icon icon-mastodon" width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" xml:space="preserve">
    <path d="M21.327 8.566c0-4.339-2.843-5.61-2.843-5.61-1.433-.658-3.894-.935-6.451-.956h-.063c-2.557.021-5.016.298-6.45.956 0 0-2.843 1.272-2.843 5.61 0 .993-.019 2.181.012 3.441.103 4.243.778 8.425 4.701 9.463 1.809.479 3.362.579 4.612.51 2.268-.126 3.541-.809 3.541-.809l-.075-1.646s-1.621.511-3.441.449c-1.804-.062-3.707-.194-3.999-2.409a4.523 4.523 0 0 1-.04-.621s1.77.433 4.014.536c1.372.063 2.658-.08 3.965-.236 2.506-.299 4.688-1.843 4.962-3.254.434-2.223.398-5.424.398-5.424zm-3.353 5.59h-2.081V9.057c0-1.075-.452-1.62-1.357-1.62-1 0-1.501.647-1.501 1.927v2.791h-2.069V9.364c0-1.28-.501-1.927-1.502-1.927-.905 0-1.357.546-1.357 1.62v5.099H6.026V8.903c0-1.074.273-1.927.823-2.558.566-.631 1.307-.955 2.228-.955 1.065 0 1.872.409 2.405 1.228l.518.869.519-.869c.533-.819 1.34-1.228 2.405-1.228.92 0 1.662.324 2.228.955.549.631.822 1.484.822 2.558v5.253z" />
</svg>
				<span>Mastodon</span>
			</a>
		</div>
		
	</div>
</div>
<div class="widget-recent widget">
	<h4 class="widget__title">Recent Posts</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/2022/11/01/building-a-url-shortener-in-12-lines-of-code-using-cloudflare-workers/">Building a URL shortener in 12 lines of code using Cloudflare Workers</a></li>
			<li class="widget__item"><a class="widget__link" href="/2022/09/19/using-multiple-json-serialization-settings-in-aspnet-core/">Using multiple JSON serialization settings in ASP.NET Core</a></li>
			<li class="widget__item"><a class="widget__link" href="/2021/11/12/building-a-project-that-target-net-45-in-visual-studio-2022/">Building a project that target .NET Framework 4.5 in Visual Studio 2022</a></li>
			<li class="widget__item"><a class="widget__link" href="/2021/11/04/a-quick-review-of-csharp-10-new-language-features/">A quick review of C# 10 new language features</a></li>
			<li class="widget__item"><a class="widget__link" href="/2021/03/19/csharp-9-records-as-strongly-typed-ids-part-5-final-bits-and-conclusion/">C# 9 records as strongly-typed ids - Part 5: final bits and conclusion</a></li>
		</ul>
	</div>
</div>
<div class="widget-taglist widget">
	<h4 class="widget__title">Top tags</h4>
	<div class="widget__content">
		<a class="widget-taglist__link widget__link btn" href="/tags/c%23/" title="c#">c#</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/wpf/" title="wpf">wpf</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/asp.net-core/" title="asp.net-core">asp.net-core</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/xaml/" title="xaml">xaml</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/async/" title="async">async</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/visual-studio/" title="visual-studio">visual-studio</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/json/" title="json">json</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/.net-core/" title=".net-core">.net-core</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/c%23-9/" title="c#-9">c#-9</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/linq/" title="linq">linq</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/unit-testing/" title="unit-testing">unit-testing</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/binding/" title="binding">binding</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/dependency-injection/" title="dependency-injection">dependency-injection</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/markup-extension/" title="markup-extension">markup-extension</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/mvvm/" title="mvvm">mvvm</a>
	</div>
</div>
</aside>
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 Thomas Levesque.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>